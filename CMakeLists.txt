cmake_minimum_required(VERSION 3.20)
project(DeviceVector_Fortran LANGUAGES CXX Fortran CUDA)

# ==========================================
# 1. å…¨åŸŸè¨­å®š
# ==========================================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CUDA_STANDARD 17)

set(CMAKE_CUDA_SEPARABLE_COMPILATION OFF)

# [RTX 4090 å°ˆç”¨æš´åŠ› Flags]
set(CUDA_HARDCODED_FLAGS "-gencode arch=compute_89,code=sm_89 -gencode arch=compute_89,code=compute_89")
set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} ${CUDA_HARDCODED_FLAGS}")

# [ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®æ­£ ğŸ”¥ğŸ”¥ğŸ”¥] 
# åŒæ™‚é–‹å•Ÿ -acc èˆ‡ -cudaã€‚
# -acc: è™•ç† OpenACC æŒ‡ä»¤
# -cuda: è™•ç† CUDA Fortran (ATTRIBUTES, DEVICE, <<<>>>)
set(FORTRAN_GPU_FLAGS "-acc" "-cuda" "-gpu=cc89")

# ==========================================
# 2. æ ¸å¿ƒç¨‹å¼åº«
# ==========================================
include_directories(src/cuda src/include src/openacc)

add_library(DeviceVector_Lib STATIC
    src/cuda/c_interface.cu
    src/cuda/DeviceEnv.cu
    src/openacc/acc_interop.cpp
)
set_target_properties(DeviceVector_Lib PROPERTIES POSITION_INDEPENDENT_CODE ON)

# Fortran ä»‹é¢
add_library(DeviceVector_Mod STATIC
    src/fortran/Device_Interface_Openacc.F90
    src/fortran/Device_Interface.F90
)

# [é€™è£¡ä¿®æ­£] å°‡ -cuda æ³¨å…¥ç·¨è­¯éšæ®µ
target_compile_options(DeviceVector_Mod PUBLIC $<$<COMPILE_LANGUAGE:Fortran>:${FORTRAN_GPU_FLAGS}>)
target_link_libraries(DeviceVector_Mod PUBLIC DeviceVector_Lib)

# ==========================================
# 3. Tests & Profiles (åˆä½µé‚è¼¯)
# ==========================================
set(ALL_SOURCES ${TEST_SOURCES} ${PROFILE_SOURCES})

# é€™è£¡å»ºç«‹ä¸€å€‹æ¸…å–®æ–¹ä¾¿è™•ç†
file(GLOB TEST_SOURCES "tests/*.F90")
file(GLOB PROFILE_SOURCES "profile/*.F90")

macro(ADD_FORTRAN_GPU_EXE target_name source_file)
    add_executable(${target_name} ${source_file})
    
    # é€£çµ DeviceVector_Mod (å®ƒå·²ç¶“å¸¶æœ‰ -acc -cuda)
    target_link_libraries(${target_name} PUBLIC 
        DeviceVector_Mod
        "-Wl,--whole-archive" DeviceVector_Lib "-Wl,--no-whole-archive"
        "cudart"
    )

    set_target_properties(${target_name} PROPERTIES LINKER_LANGUAGE Fortran)
    
    # [é€™è£¡ä¿®æ­£] å¼·åˆ¶çµ¦äºˆç·¨è­¯é¸é …
    target_compile_options(${target_name} PRIVATE $<$<COMPILE_LANGUAGE:Fortran>:${FORTRAN_GPU_FLAGS}>)

    if(CMAKE_Fortran_COMPILER_ID MATCHES "NVHPC")
        # å†æ¬¡å¼·èª¿é€£çµæ™‚ä¹Ÿè¦å¸¶ä¸Šï¼Œç¢ºä¿ runtime å°é½Š
        set_property(TARGET ${target_name} PROPERTY LINK_FLAGS "-acc -cuda -gpu=cc89 -c++libs")
    endif()
endmacro()

# æ‰¹é‡ç”Ÿæˆ
foreach(source ${TEST_SOURCES})
    get_filename_component(name ${source} NAME_WE)
    ADD_FORTRAN_GPU_EXE(${name} ${source})
endforeach()

foreach(source ${PROFILE_SOURCES})
    get_filename_component(name ${source} NAME_WE)
    ADD_FORTRAN_GPU_EXE(${name} ${source})
endforeach()

message(STATUS "Auto-detected Tests: ${TEST_SOURCES}")
message(STATUS "Auto-detected Profiles: ${PROFILE_SOURCES}")